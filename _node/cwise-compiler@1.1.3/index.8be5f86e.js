import*as S from"../uniq@1.0.1/index.44f0f512.js";function A(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function _(r){return r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var C=_(S),O=C;function I(r,e,i){var s=r.length,h=e.arrayArgs.length,a=e.indexArgs.length>0,p=[],l=[],n=0,o=0,t,u;for(t=0;t<s;++t)l.push(["i",t,"=0"].join(""));for(u=0;u<h;++u)for(t=0;t<s;++t)o=n,n=r[t],t===0?l.push(["d",u,"s",t,"=t",u,"p",n].join("")):l.push(["d",u,"s",t,"=(t",u,"p",n,"-s",o,"*t",u,"p",o,")"].join(""));for(l.length>0&&p.push("var "+l.join(",")),t=s-1;t>=0;--t)n=r[t],p.push(["for(i",t,"=0;i",t,"<s",n,";++i",t,"){"].join(""));for(p.push(i),t=0;t<s;++t){for(o=n,n=r[t],u=0;u<h;++u)p.push(["p",u,"+=d",u,"s",t].join(""));a&&(t>0&&p.push(["index[",o,"]-=s",o].join("")),p.push(["++index[",n,"]"].join(""))),p.push("}")}return p.join(`
`)}function T(r,e,i,s){for(var h=e.length,a=i.arrayArgs.length,p=i.blockSize,l=i.indexArgs.length>0,n=[],o=0;o<a;++o)n.push(["var offset",o,"=p",o].join(""));for(var o=r;o<h;++o)n.push(["for(var j"+o+"=SS[",e[o],"]|0;j",o,">0;){"].join("")),n.push(["if(j",o,"<",p,"){"].join("")),n.push(["s",e[o],"=j",o].join("")),n.push(["j",o,"=0"].join("")),n.push(["}else{s",e[o],"=",p].join("")),n.push(["j",o,"-=",p,"}"].join("")),l&&n.push(["index[",e[o],"]=j",o].join(""));for(var o=0;o<a;++o){for(var t=["offset"+o],u=r;u<h;++u)t.push(["j",u,"*t",o,"p",e[u]].join(""));n.push(["p",o,"=(",t.join("+"),")"].join(""))}n.push(I(e,i,s));for(var o=r;o<h;++o)n.push("}");return n.join(`
`)}function N(r){for(var e=0,i=r[0].length;e<i;){for(var s=1;s<r.length;++s)if(r[s][e]!==r[0][e])return e;++e}return e}function v(r,e,i){for(var s=r.body,h=[],a=[],p=0;p<r.args.length;++p){var l=r.args[p];if(!(l.count<=0)){var n=new RegExp(l.name,"g"),o="",t=e.arrayArgs.indexOf(p);switch(e.argTypes[p]){case"offset":var u=e.offsetArgIndex.indexOf(p),c=e.offsetArgs[u];t=c.array,o="+q"+u;case"array":o="p"+t+o;var f="l"+p,g="a"+t;if(e.arrayBlockIndices[t]===0)l.count===1?i[t]==="generic"?l.lvalue?(h.push(["var ",f,"=",g,".get(",o,")"].join("")),s=s.replace(n,f),a.push([g,".set(",o,",",f,")"].join(""))):s=s.replace(n,[g,".get(",o,")"].join("")):s=s.replace(n,[g,"[",o,"]"].join("")):i[t]==="generic"?(h.push(["var ",f,"=",g,".get(",o,")"].join("")),s=s.replace(n,f),l.lvalue&&a.push([g,".set(",o,",",f,")"].join(""))):(h.push(["var ",f,"=",g,"[",o,"]"].join("")),s=s.replace(n,f),l.lvalue&&a.push([g,"[",o,"]=",f].join("")));else{for(var y=[l.name],w=[o],d=0;d<Math.abs(e.arrayBlockIndices[t]);d++)y.push("\\s*\\[([^\\]]+)\\]"),w.push("$"+(d+1)+"*t"+t+"b"+d);if(n=new RegExp(y.join(""),"g"),o=w.join("+"),i[t]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");s=s.replace(n,[g,"[",o,"]"].join(""))}break;case"scalar":s=s.replace(n,"Y"+e.scalarArgs.indexOf(p));break;case"index":s=s.replace(n,"index");break;case"shape":s=s.replace(n,"shape");break}}}return[h.join(`
`),s,a.join(`
`)].join(`
`).trim()}function q(r){for(var e=new Array(r.length),i=!0,s=0;s<r.length;++s){var h=r[s],a=h.match(/\d+/);a?a=a[0]:a="",h.charAt(0)===0?e[s]="u"+h.charAt(1)+a:e[s]=h.charAt(0)+a,s>0&&(i=i&&e[s]===e[s-1])}return i?e[0]:e.join("")}function D(r,e){for(var i=e[1].length-Math.abs(r.arrayBlockIndices[0])|0,s=new Array(r.arrayArgs.length),h=new Array(r.arrayArgs.length),a=0;a<r.arrayArgs.length;++a)h[a]=e[2*a],s[a]=e[2*a+1];for(var p=[],l=[],n=[],o=[],t=[],a=0;a<r.arrayArgs.length;++a){r.arrayBlockIndices[a]<0?(n.push(0),o.push(i),p.push(i),l.push(i+r.arrayBlockIndices[a])):(n.push(r.arrayBlockIndices[a]),o.push(r.arrayBlockIndices[a]+i),p.push(0),l.push(r.arrayBlockIndices[a]));for(var u=[],c=0;c<s[a].length;c++)n[a]<=s[a][c]&&s[a][c]<o[a]&&u.push(s[a][c]-n[a]);t.push(u)}for(var f=["SS"],g=["'use strict'"],y=[],c=0;c<i;++c)y.push(["s",c,"=SS[",c,"]"].join(""));for(var a=0;a<r.arrayArgs.length;++a){f.push("a"+a),f.push("t"+a),f.push("p"+a);for(var c=0;c<i;++c)y.push(["t",a,"p",c,"=t",a,"[",n[a]+c,"]"].join(""));for(var c=0;c<Math.abs(r.arrayBlockIndices[a]);++c)y.push(["t",a,"b",c,"=t",a,"[",p[a]+c,"]"].join(""))}for(var a=0;a<r.scalarArgs.length;++a)f.push("Y"+a);if(r.shapeArgs.length>0&&y.push("shape=SS.slice(0)"),r.indexArgs.length>0){for(var w=new Array(i),a=0;a<i;++a)w[a]="0";y.push(["index=[",w.join(","),"]"].join(""))}for(var a=0;a<r.offsetArgs.length;++a){for(var d=r.offsetArgs[a],j=[],c=0;c<d.offset.length;++c)d.offset[c]!==0&&(d.offset[c]===1?j.push(["t",d.array,"p",c].join("")):j.push([d.offset[c],"*t",d.array,"p",c].join("")));j.length===0?y.push("q"+a+"=0"):y.push(["q",a,"=",j.join("+")].join(""))}var B=O([].concat(r.pre.thisVars).concat(r.body.thisVars).concat(r.post.thisVars));y=y.concat(B),y.length>0&&g.push("var "+y.join(","));for(var a=0;a<r.arrayArgs.length;++a)g.push("p"+a+"|=0");r.pre.body.length>3&&g.push(v(r.pre,r,h));var m=v(r.body,r,h),b=N(t);b<i?g.push(T(b,t[0],r,m)):g.push(I(t[0],r,m)),r.post.body.length>3&&g.push(v(r.post,r,h)),r.debug&&console.log("-----Generated cwise routine for ",e,`:
`+g.join(`
`)+`
----------`);var k=[r.funcName||"unnamed","_cwise_loop_",s[0].join("s"),"m",b,q(h)].join(""),M=new Function(["function ",k,"(",f.join(","),"){",g.join(`
`),"} return ",k].join(""));return M()}var x=D;A(x);var F=x;function V(r){var e=["'use strict'","var CACHED={}"],i=[],s=r.funcName+"_cwise_thunk";e.push(["return function ",s,"(",r.shimArgs.join(","),"){"].join(""));for(var h=[],a=[],p=[["array",r.arrayArgs[0],".shape.slice(",Math.max(0,r.arrayBlockIndices[0]),r.arrayBlockIndices[0]<0?","+r.arrayBlockIndices[0]+")":")"].join("")],l=[],n=[],o=0;o<r.arrayArgs.length;++o){var t=r.arrayArgs[o];i.push(["t",t,"=array",t,".dtype,","r",t,"=array",t,".order"].join("")),h.push("t"+t),h.push("r"+t),a.push("t"+t),a.push("r"+t+".join()"),p.push("array"+t+".data"),p.push("array"+t+".stride"),p.push("array"+t+".offset|0"),o>0&&(l.push("array"+r.arrayArgs[0]+".shape.length===array"+t+".shape.length+"+(Math.abs(r.arrayBlockIndices[0])-Math.abs(r.arrayBlockIndices[o]))),n.push("array"+r.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[0])+"]===array"+t+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[o])+"]"))}r.arrayArgs.length>1&&(e.push("if (!("+l.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+r.arrayArgs[0]+".shape.length-"+Math.abs(r.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),e.push("if (!("+n.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}"));for(var o=0;o<r.scalarArgs.length;++o)p.push("scalar"+r.scalarArgs[o]);i.push(["type=[",a.join(","),"].join()"].join("")),i.push("proc=CACHED[type]"),e.push("var "+i.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",h.join(","),"])}","return proc(",p.join(","),")}"].join("")),r.debug&&console.log(`-----Generated thunk:
`+e.join(`
`)+`
----------`);var u=new Function("compile",e.join(`
`));return u(F.bind(void 0,r))}var E=V;A(E);var z=E;function G(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function H(r){var e=new G;e.pre=r.pre,e.body=r.body,e.post=r.post;var i=r.args.slice(0);e.argTypes=i;for(var s=0;s<i.length;++s){var h=i[s];if(h==="array"||typeof h=="object"&&h.blockIndices){if(e.argTypes[s]="array",e.arrayArgs.push(s),e.arrayBlockIndices.push(h.blockIndices?h.blockIndices:0),e.shimArgs.push("array"+s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array args");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array args")}else if(h==="scalar")e.scalarArgs.push(s),e.shimArgs.push("scalar"+s);else if(h==="index"){if(e.indexArgs.push(s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array index");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array index");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array index")}else if(h==="shape"){if(e.shapeArgs.push(s),s<e.pre.args.length&&e.pre.args[s].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array shape");if(s<e.post.args.length&&e.post.args[s].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof h=="object"&&h.offset)e.argTypes[s]="offset",e.offsetArgs.push({array:h.array,offset:h.offset}),e.offsetArgIndex.push(s);else throw new Error("cwise: Unknown argument type "+i[s])}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>i.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>i.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>i.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!r.printCode||!!r.debug,e.funcName=r.funcName||"cwise",e.blockSize=r.blockSize||64,z(e)}var P=H,R=A(P);export{R as default};
